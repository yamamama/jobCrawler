<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="common/head :: head"></head>
<title>中移运营支撑系统-用户</title>
<body class="no-skin">
<div class="main-container" id="main-container">

    <!-- /section:basics/sidebar -->
    <div class="main-content">
        <div class="main-content-inner">
            <div class="page-content">
                <div class="row">
                    <!-- /.page-header -->
                    <div class="col-xs-12 col-sm-12 widget-container-col">
                        <div class="widget-box widget-color-green">
                            <!-- #section:custom/widget-box.options -->
                            <div class="widget-header">
                                <h5 class="widget-title">
                                    <i class="ace-icon fa fa-filter bigger-130"></i>查询内容
                                </h5>
                                <div class="widget-toolbar no-border">
                                    <a href="#" data-action="collapse" class="orange2"> <i
                                            class="1 ace-icon fa fa-chevron-up bigger-125 "></i>
                                    </a>
                                </div>
                                <div class="widget-toolbar no-border">

                                    <button class="btn btn-xs btn-yellow" onClick="doQuery();">
                                        <i class="ace-icon fa fa-search icon-on-left"></i>查询
                                    </button>

                                    <button class="btn btn-xs btn-light" onClick="doQueryReset();">
                                        <i class="ace-icon fa fa-refresh"></i> 重置
                                    </button>

                                </div>
                            </div>

                            <!-- /section:custom/widget-box.options -->
                            <div class="widget-body">
                                <div class="widget-main">
                                    <div class="clearfix">
                                        <form id='queryForm' class="form-horizontal" role="form">
                                            <div class="row">
                                                <!-- PAGE CONTENT BEGINS -->
                                                <div class="form-group col-sm-3">
                                                    <label class="col-sm-4 control-label no-padding-right">资源名称</label>
                                                    <div class="col-sm-8">
                                                        <input type="text" name="names"
                                                               class="col-xs-10 col-sm-12 input-sm"/>
                                                    </div>
                                                </div>
                                                <div class="form-group col-sm-3">
                                                    <label class="col-sm-4 control-label no-padding-right">资源类型</label>
                                                    <div class="col-sm-8">
                                                        <select name="type" id="type" class="col-xs-10 col-sm-12 input-sm type">
                                                            <option value="-1">请选择</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="form-group col-sm-3">
                                                    <label class="col-sm-4 control-label no-padding-right">资源来源</label>
                                                    <div class="col-sm-8">
                                                        <select name="origins" id="origins" class="col-xs-10 col-sm-12 input-sm origins">
                                                                class="col-xs-10 col-sm-12 input-sm">
                                                            <option value="-1">请选择</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="form-group col-sm-3">
                                                    <div class="col-sm-4 control-label no-padding-right" for="form-field-2">状态</div>
                                                    <div class="col-sm-8">
                                                        <select name="status"  class="col-xs-8 col-sm-12 input-sm">
                                                            <option value="0">禁用</option>
                                                            <option value="1" selected="selected">可用</option>
                                                            <option value="2">已过期</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="form-group col-sm-3">
                                                    <label class="col-sm-4 control-label no-padding-right">可以渠道</label>
                                                    <div class="col-sm-8">
                                                        <select name="channels" id="channels"
                                                                class="col-xs-10 col-sm-12 input-sm channels">
                                                            <option value="-1">请选择</option>
                                                            <option value="0">全部渠道</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="form-group col-sm-6">
                                                    <label class="col-sm-4 control-label no-padding-right">资源有效期</label>
                                                    <div class="col-sm-8">
                                                        <div class="input-group">
                                                            <input type="text" placeholder="开始时间"
                                                                   class="form_datetime input-sm form-control"
                                                                   name="beginTime"/> <span
                                                                class="input-group-addon"> <i
                                                                class="fa fa-exchange"></i></span>
                                                            <input type="text" placeholder="结束时间"
                                                                   class="form_datetime input-sm form-control" name="endTime"/>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- /.span -->
                </div>
                <!-- /.row -->


                <div class="row">
                    <!-- /.page-header -->
                    <div class="col-xs-12 col-sm-12 widget-container-col">
                        <div class="widget-box widget-color-green">
                            <!-- #section:custom/widget-box.options -->
                            <div class="widget-header">
                                <h5 class="widget-title">
                                    <i class="ace-icon fa fa-table bigger-130"></i>数据列表
                                </h5>

                                <div class="widget-toolbar no-border">
                                    <a href="#" data-action="fullscreen" class="orange2"> <i
                                            class="ace-icon fa fa-expand bigger-125"></i>
                                    </a>
                                </div>

                                <div class="widget-toolbar no-border">
                                    <button class="btn btn-xs btn-yellow" onclick="goToPage('/mk/resType/page')">
                                        <i class="ace-icon fa fa-cog icon-on-left"></i>资源类型管理
                                    </button>
                                    <div class="widget-toolbar no-border">
                                        <button class="btn btn-xs btn-yellow" onClick="usedList();">
                                            <i class="ace-icon fa fa-plus icon-on-left"></i>使用列表
                                        </button>

                                        <button class="btn btn-xs btn-yellow" onClick="add();">
                                            <i class="ace-icon fa fa-plus icon-on-left"></i>新增
                                        </button>

                                        <button class="btn btn-xs btn-yellow" onClick="edit();">
                                            <i class="ace-icon fa fa-edit icon-on-left"></i>修改
                                        </button>

                                        <button class="btn btn-xs btn-yellow" onClick="doDelete();">
                                            <i class="ace-icon fa fa-trash-o icon-on-left"></i>停用
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- /section:custom/widget-box.options -->
                            <div class="widget-body">
                                <div class="widget-main"
                                     style="padding-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px;">
                                    <div class="clearfix">
                                        <div class="row">
                                            <div class="col-xs-12">
                                                <table id="dataTable" style="width: 100%"
                                                       class="table table-striped table-bordered table-hover form-inline">
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- /.span -->
                </div>
                <!-- /.row -->

                <!-- 弹框 -->
                <div id="modal-form" class="modal" tabindex="-1">
                    <div class="modal-dialog" style="width:500px;">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                                <font class="blue">资源信息</font>
                            </div>

                            <div class="modal-body">
                                <form id="dataform" class="form-horizontal" method="post">
                                    <!-- #section:elements.form -->
                                    <input type="hidden" id="id" name="id" value=""/>
                                    <div class="form-group">
                                        <div class="control-label col-xs-12 col-sm-3 no-padding-right" for="name">资源名称</div>
                                        <div class="col-xs-12 col-sm-9">
                                            <div class="clearfix">
                                                <input type="text" id="name" name="name" value="" placeholder="资源名称" required="required"
                                                       class="col-xs-12 col-sm-8"/>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="control-label col-xs-12 col-sm-3 no-padding-right" for="name">资源类型</div>
                                        <div class="col-xs-12 col-sm-9">
                                            <div class="clearfix">
                                                <select name="type" class="col-xs-12 col-sm-8 type">

                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="control-label col-xs-12 col-sm-3 no-padding-right" for="name">来源</div>
                                        <div class="col-xs-12 col-sm-9">
                                            <div class="clearfix">
                                                <select name="origin" class="col-xs-12 col-sm-8 origins" >

                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="control-label col-xs-12 col-sm-3 no-padding-right" for="name">资源总量</div>
                                        <div class="col-xs-12 col-sm-9">
                                            <div class="clearfix">
                                                <input type="text" id="totalCount" name="totalCount" value="" placeholder="资源总量" required="required"
                                                       class="col-xs-12 col-sm-8"/>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group creat">
                                        <div class="control-label col-xs-12 col-sm-3 no-padding-right" for="name">冻结数量</div>
                                        <div class="col-xs-12 col-sm-9">
                                            <div class="clearfix">
                                                <input type="text" id="freezedCount" name="freezedCount" value="" placeholder="冻结数量"
                                                       class="col-xs-12 col-sm-8"/>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group creat">
                                        <div class="control-label col-xs-12 col-sm-3 no-padding-right" for="name">使用数量</div>
                                        <div class="col-xs-12 col-sm-9">
                                            <div class="clearfix">
                                                <input type="text" id="usedCount" name="usedCount" value="" placeholder="使用数量"
                                                       class="col-xs-12 col-sm-8"/>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group creat">
                                        <div class="control-label col-xs-12 col-sm-3 no-padding-right" for="name">联系人信息</div>
                                        <div class="col-xs-12 col-sm-9">
                                            <div class="clearfix">
                                                <input type="text" id="contact" name="contact" value="" placeholder="联系人信息"
                                                       class="col-xs-12 col-sm-8"/>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="control-label col-xs-12 col-sm-3 no-padding-right" for="name">使用渠道</div>
                                        <div class="col-xs-12 col-sm-9">
                                            <div class="clearfix">
                                                <select name="useChannels" class="col-xs-12 col-sm-8 channels">

                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="control-label col-xs-12 col-sm-3 no-padding-right" for="name">资源批次</div>
                                        <div class="col-xs-12 col-sm-9">
                                            <div class="clearfix">
                                                <input type="text" id="version" name="version" value="" placeholder="资源批次" required="required"
                                                       class="col-xs-12 col-sm-8"/>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="control-label col-xs-12 col-sm-3 no-padding-right" for="name">有效期</div>
                                        <div class="col-xs-12 col-sm-9">
                                            <div class="clearfix">
                                                <input type="text" placeholder="开始时间"
                                                       class="form_datetime input-sm form-control"
                                                       name="effectiveTime"/></div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="col-sm-3 control-label no-padding-right" for="form-field-2">状态：</div>
                                        <div class="col-sm-8">
                                            <div class="radio">
                                                <label>
                                                    <input name="locked" type="radio" class="ace" checked="true" value="0"/>
                                                    <span class="lbl">&nbsp;&nbsp;可用</span>
                                                </label>
                                                <label>
                                                    <input name="locked" type="radio" class="ace" value="1"/>
                                                    <span class="lbl">&nbsp;&nbsp;禁用</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-sm" data-dismiss="modal">
                                    <i class="ace-icon fa fa-times"></i>
                                    取消
                                </button>

                                <button class="btn btn-sm btn-primary" id="btnsave" onclick="save();">
                                    <i class="ace-icon fa fa-check"></i>
                                    保存
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- ／弹框 -->
                <!-- PAGE CONTENT ENDS -->
            </div>
        </div>
    </div>
</div>

<div th:include="/common/common_js :: onloadJS"></div>

<script type="text/javascript">
    cmdList = "/mk/list";
    cmdSave = "/mk/add";
    cmdQuery = "/mk/view";
    cmdDelete = "/mk/delete";
    cmdUsed = "/mk/used";

    var dataTable = null;
    var resType = null;
    jQuery(function ($) {
        dataTable = $('#dataTable').dataTable(
            {
                //数据列控制（包括对应返回JSON属性名称，对应表头列索引位置、数据转换封装等）
                "aoColumnDefs": [
                    {
                        "sTitle": "<div class='center'><input type='checkbox' id='selectAll'/></div>",
                        "sName": "id", //库表字段名
                        "mData": "id", //JSON返回属性
                        "aTargets": [0], //第几列
                        "mRender": function (value, type, row) {
                            return "<div class='center'><input  type='checkbox' name='id' value='" + value + "'/></div>";
                        },
                        "bSortable": false
                        //是否排序，默认排序
                    },
                    {
                        "sTitle": "资源名称",
                        "sName": "name",
                        "mData": "name",
                        "aTargets": [1],
                        "bSortable": false
                    },
                    {
                        "sTitle": "资源类型",
                        "sName": "type",
                        "mData": "type",
                        "aTargets": [2],
                        "bSortable": false,
                        "mRender": function (value, type, row) {
                            resType = value;
                            return ParamTool.getTranHtml("RESTYPES", value.type) + value.name;

                        }
                    },
                    {
                        "sTitle": "资源来源",
                        "sName": "origin",
                        "mData": "origin",
                        "aTargets": [3],
                        "bSortable": false
                    },
                    {
                        "sTitle": "资源总量",
                        "sName": "totalCount",
                        "mData": "totalCount",
                        "aTargets": [4],
                        "bSortable": false,
                        "mRender": function (value, type, row) {
                            return value + ParamTool.getTranHtml("RESUNIT", resType.unit);

                        }
                    },
                    {
                        "sTitle": "冻结数量",
                        "sName": "freezedCount",
                        "mData": "freezedCount",
                        "aTargets": [5],
                        "bSortable": false,
                        "mRender": function (value, type, row) {
                            return value + ParamTool.getTranHtml("RESUNIT", resType.unit);

                        }
                    },
                    {
                        "sTitle": "使用数量",
                        "sName": "usedCount",
                        "mData": "usedCount",
                        "aTargets": [6],
                        "bSortable": false,
                        "mRender": function (value, type, row) {
                            return value + ParamTool.getTranHtml("RESUNIT", resType.unit);

                        }
                    },
                    {
                        "sTitle": "资源批次",
                        "sName": "version",
                        "mData": "version",
                        "aTargets": [7],
                        "bSortable": false
                    },
                    {
                        "sTitle": "有效期",
                        "sName": "effectiveTime",
                        "mData": "effectiveTime",
                        "aTargets": [8],
                        "bSortable": true,
                        "mRender": function (value, type, row) {
                            return new Date(value).Format("yyyy-MM-dd hh:mm:ss");
                        }
                    },
                    {
                        "sTitle": "创建时间",
                        "sName": "creatTime",
                        "mData": "creatTime",
                        "aTargets": [9],
                        "bSortable": true,
                        "mRender": function (value, type, row) {
                            return new Date(value).Format("yyyy-MM-dd hh:mm:ss");
                        }
                    },
                    {
                        "sTitle": "使用状态",
                        "sName": "locked",
                        "mData": "locked",
                        "aTargets": [10],
                        "bSortable": true,
                        "mRender": function (value, type, row) {
                            return ParamTool.getTranHtml("STATUS", value);
                        }
                    }],
                "sAjaxSource": cmdList
                //数据源URL
            });
    });


    //新增前清空表单
    function add() {
        $("#dataform")[0].reset();
        $("#dataform input[name='id']").val("");
        $(".creat").hide();
        $('#modal-form').modal('show');
    }

    function goToPage(url) {
        window.location.href = url;
    }

    /**
     * 初始化字典数据表单校验规则器
     *        弹出字典数据编辑窗口前调用
     */
    function initUserFormValidator() {
        $('#dataform').validate({
            rules: {
                'name': {
                    required: true
                },
                'type': {
                    required: true
                },
                'describe': {
                    required: true
                },
                'account': {
                    required: true
                }
            }
        });
    }

    //保存表单信息
    function save() {
        $.ajax({
            "dataType": 'json',
            "type": "POST",
            "url": cmdSave,
            "data": $('#dataform').serialize(),
            "success": function (data) {
                var json = eval(data);
                if (data.status == "SUCCESS") {
                    $("#modal-form").modal('hide');
                    dataTable.fnDraw();
                } else {
                    alert("保存失败，请稍后重试！");
                }
            }
        });
    }

    //编辑表单信息
    function edit() {
        var pkvalue = checkEdit();
        if (pkvalue == false || pkvalue == "") {
            return false;
        }
        $.ajax({
            "dataType": 'json',
            "type": "POST",
            "url": cmdQuery,
            "data": {"id": pkvalue},
            "success": function (data) {
                var json = eval(data);
                if (json.status == "SUCCESS") {
                    var stock = json.data;
                    $("#dataform input[name='id']").val(stock.id);
                    $("#dataform input[name='origin']").val(stock.origin);
                    $("#dataform input[name='type']").val(stock.type);
                    $("#dataform input[name='useChannels']").val(stock.useChannels);
                    $("#dataform input[name='freezedCount']").val(stock.freezedCount);
                    $("#dataform input[name='totalCount']").val(stock.totalCount);
                    $("#dataform input[name='usedCount']").val(stock.usedCount);
                    $("#dataform input[name='effectivetime']").val(new Date(stock.effectivetime).Format("yyyy-MM-dd hh:mm:ss"));
                    $("#dataform input[name='contact']").val(stock.contact);
                    if (channel.available == '1') {
                        $("#dataform input[name='locked'][value=1]").attr("checked", true);
                        $("#dataform input[name='locked'][value=0]").attr("checked", false);
                    } else {
                        $("#dataform input[name='locked'][value=0]").attr("checked", true);
                        $("#dataform input[name='locked'][value=1]").attr("checked", false);
                    }
                    if (type == 1) {
                        //不可修改的隐藏
                    }
                    $('#modal-form').modal('show');

                } else {
                    alert("查找失败");
                }
            }
        });
    }

    //删除数据
    function doDelete() {
        var pkvalue = checkEdit();
        if (pkvalue == false || pkvalue == "") {
            return false;
        }
        $.ajax({
            "dataType": 'json',
            "type": "POST",
            "url": cmdDelete,
            "data": {"id": pkvalue},
            "success": function (data) {
                var json = eval(data);
                if (data.status == "SUCCESS") {
                    alert("删除成功");
                    dataTable.fnDraw();
                } else {
                    alert("删除失败");
                }
            }
        });
    }

    $(function () {
        $("#checkAll").on('click', checkClick);
        $('.form_datetime').datetimepicker({
            format: "YYYY-MM-DD HH:mm:ss",
            showTodayButton: true,
            showClear: true,
            showClose: true
        });
        $.ajax({
            type: "POST",
            url: "/dict/query?dictCode=RESORIGIN",
            success: function (data) {
                rest = data.data.dictDatas;
                $(rest).each(function (index, value) {
                    $(".origins").append("<option value=" + value.dictdataValue + ">" + value.dictdataName + "</option>");
                })
            }
        });
        $.ajax({
            type: "POST",
            url: "/dict/query?dictCode=RESTYPES",
            success: function (data) {
                rest = data.data.dictDatas;
                $(rest).each(function (index, value) {
                    $(".type").append("<option value=" + value.dictdataValue + ">" + value.dictdataName + "</option>");
                })
            }
        });

        $.ajax({
            type: "POST",
            url: "/channels/listAll",
            success: function (data) {
                $(data).each(function (index, value) {
                    $(".channels").append("<option value=" + value.id + ">" + value.name + "</option>");
                })
            }
        });
    });
</script>
</body>
</html>